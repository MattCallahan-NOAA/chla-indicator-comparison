---
title: "Chlorophyll indicator comparison"
author: "Matt Callahan"
date: "6/15/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidync)
library(tidyverse)
library(lubridate)
library(sf)
library(httr)
library(flextable)
```




## MODIS
MODIS data were downloaded from a google folder where Jordan stored them from previous efforts https://drive.google.com/drive/u/1/folders/1mhwQ70mjLrkiQYiQ2oNHx08Q7IlL8Q3-

```{r}
#EBS
mod_ebs<-readRDS("Data/MODIS/merged_8day_2003_2021_EBS.RDS")
#GOA

```

## OC-CCI
**Download 8 day OC-CCI data**
If we import MODIS into AKFIN we will probably import daily chlorophyll and calculate 8 day values, but for now I will download the 8 day product.
```{r}
#Download one day of grid east of the dateline
#extent 47, 70, -130, -180
   download.file(url = "https://coastwatch.pfeg.noaa.gov/erddap/griddap/pmlEsaCCI50OceanColorDaily.nc?chlor_a%5B(2021-06-01T00:00:00Z)%5D%5B(69):(47)%5D%5B(-179.99):(-130)%5D&.draw=surface&.vars=longitude%7Clatitude%7Cchlor_a&.colorBar=%7C%7C%7C%7C%7C&.bgColor=0xffccccff", method = "libcurl", mode="wb",destfile = "Data/OCCCI/occci_06012021.nc")

#import as data file
tidy_chl<-function(file) {
  tidync(file) %>% 
  hyper_tibble()%>% 
  mutate(date=as_datetime(time),
                  chlorophyll=round(chlor_a,3))
  
}

#rounding fields if needed
 #        lonc=as.numeric(ifelse(longitude<0, #ifelse statement keeps +- lons the same length
  #                              substr(longitude,1,8),
  #                              substr(longitude,1,7))), 
   #      latc=as.numeric(substr(latitude,1,6)), 
         

occ<-tidy_chl("Data/OCCCI/occci_06012021.nc")
#Make lookup table similar to process for VIIRS
#max and min values
max(occ$latitude);min(occ$latitude)
max(occ$longitude);min(occ$longitude)
#create new vectors with 4 decimal places
lon_lkp<-c(seq(from=-179.9792, to=-129.9792, by=0.0416)) #east
#           seq(from=167.0063, to=179.9813, by=0.0375)) #not adding west of dateline for now
lat_lkp<-seq(from=46.97917, to=69.02083, by=0.04167)

#create grid
viirs_4k_grid<-expand.grid(lon_lkp, lat_lkp)%>%
           mutate(lonc=as.numeric(ifelse(Var1<0, 
                                substr(Var1,1,8),
                                substr(Var1,1,7))), #from Jordan's code
         latc=as.numeric(substr(Var2,1,6)))%>%
  rename(latitude=Var2, longitude=Var1)

#Download BS and GOA rectangles

#clip and merge with new lookup table

```

## VIIRS
We are currently importing viirs into AKFIN, allowing us to process indicators in the database.

## ESP indicators
These indicators were requested by stock assessment authors. Each indicator is a single value for each year.

**Previous ESP Indicator descriptions**
```{r}
#check which indicators were used
data <- httr::content(httr::GET("https://apex.psmfc.org/akfin/data_marts/akmp/esp_indicators?"),
                      type = "application/json"
) %>%
  dplyr::bind_rows()%>%
  filter(grepl('Chlorophylla', INDICATOR_NAME))

#all ours?
unique(data$CONTACT) #yes

#Descriptions
data%>%group_by(INDICATOR_NAME)%>%
  summarise(descritption=unique(PRODUCT_DESCRIPTION),
            submission_year=unique(SUBMISSION_YEAR))%>%
   flextable()%>%
  theme_box()
  write.csv("esp_chlorophyll_indicators.csv")

  #csv to send to Kalei to confirm active indicators
  data%>%group_by(INDICATOR_NAME)%>%
  summarise(descritption=unique(PRODUCT_DESCRIPTION),
            submission_year=unique(SUBMISSION_YEAR))%>%
  write.csv("esp_chlorophyll_indicators.csv")
```
**AMJ_Chlorophylla_Biomass_SEBS_Satellite**

**Spring_Chlorophylla_Biomass_EGOA_Satellite**

**Spring_Chlorophylla_Biomass_SEBS_Inner_Shelf_Satellite**

**Spring_Chlorophylla_Biomass_SEBS_Satellite**

**Spring_Chlorophylla_Biomass_SMBKC_Satellite**

**Spring_Chlorophylla_Biomass_WCGOA_Satellite**

**Spring_Chlorophylla_Peak_EGOA_Satellite**

**Spring_Chlorophylla_Peak_SEBS_Satellite**

**Spring_Chlorophylla_Peak_WCGOA_Satellite**

**Recalculate ESP indices**
```{r}
mod_ebs<-readRDS("Data/MODIS/merged_8day_2003_2021_EBS.RDS")
```